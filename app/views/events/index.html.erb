

<div id="container" >
    <div id="map" class="map">

    </div>
  <div id="slider-container">
    <div class="era list-inline">
      <li id="an" class="period" data-period='3976' style="width: <%= Event.get_period_percent(3976) %>%">Antiquité</li>
      <li id="ma" class="period" data-period='1016' style="width: <%= Event.get_period_percent(1016) %>%">Moyen Âge</li>
      <li id="tm" class="period" data-period='297' style="width: <%= Event.get_period_percent(297) %>%">T.Modernes</li>
      <li id="ec" class="period" data-period='226' style="width: <%= Event.get_period_percent(226) %>%">Contemporaine</li>
    </div>
    <input id="slider" type="range" min=<%= Event::FIRST_YEAR %> max=<%= Event::LAST_YEAR %> step="10" />
  </div>
</div>




</div>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>

var year = d3.scale.linear()
    .domain([<%= Event::FIRST_YEAR %>, <%= Event::LAST_YEAR %>])
    .range([0, 100]);

var arrayOfLatLngs = [];
  <% @events.each do |event| %>
	arrayOfLatLngs.push([<%= event.latitude %>, <%= event.longitude %>]);
  d3.select('.era').append('i').attr("class", "arrow fa fa-caret-down").style('left', year(<%= event.start_year %>)+ '%' ).html('<%= event.start_year %>');
    <% end %>

   // d3.select('.era').append('li').attr('class', 'period');

var bounds = new L.LatLngBounds(arrayOfLatLngs);



  var tileServer = 'http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png'

  var tileAttribution = 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';

  var map = L.map("map",{bounceAtZoomLimits:false, worldCopyJump:true, zoomAnimationThreshold:7}).fitBounds(bounds);

        L.tileLayer(tileServer, {attribution: tileAttribution,   noWrap:true}).addTo(map);

        var markers = {};

  var markerMap = {};
  var popUpMap = {};

  <% @events.each do |event| %>

    var marker = L.marker([<%= event.latitude %>, <%= event.longitude %>]);

      marker.id = <%= event.id %>;
      marker.start_year = <%= event.start_year %>;
      marker.period = getperiod(marker.start_year);
      markerMap[<%= event.id %>] = marker;
      popUpMap[<%= event.id %>] = markerMap[<%= event.id %>].bindPopup('<%= event.title %> <p><%= link_to("See more", event_path(event.id))  %></p>');
      // markers[<%= event.id %>] = marker ;

      marker.addTo(map);

    <% end %>

   document.getElementById('slider').addEventListener('change', function() {
        var selected = this.value;
        console.log("selected ", selected);
      _.each(markerMap, function(marker){

	map.removeLayer(marker);
	if (getperiod(selected) == marker.period){
          marker.addTo(map);
        }

      var range = 300;
      if (selected - range < marker.start_year && parseInt(selected) + range > marker.start_year){
        marker.openPopup();
      }else{
        marker.closePopup();
      }

      });

});

function getperiod(start_year){
  switch (true) {
    case start_year < <%=  Event::PERIODS[0][2]%>:
        return "<%= Event::PERIODS[0][0]%>";
        break;
    case start_year > <%= Event::PERIODS[1][1]%> && start_year < <%= Event::PERIODS[1][2]%>:
        return "<%= Event::PERIODS[1][0]%>";
        break;
    case start_year > <%= Event::PERIODS[2][1]%> && start_year < <%= Event::PERIODS[2][2]%>:
        return "<%= Event::PERIODS[2][0]%>";
        break;
    case start_year > <%= Event::PERIODS[3][1]%> && start_year < <%= Event::PERIODS[3][2]%>:
        return "<%= Event::PERIODS[3][0]%>";
        break;
   default:
        return "none";
  }

};


  <% end %>
<% end %>







